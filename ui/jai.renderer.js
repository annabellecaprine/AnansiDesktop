/*
 * Anansi Adapter Renderer: JanitorAI
 * File: js/env/jai.renderer.js
 * Extends: js/env/jai.js
 */

(function (A) {
    'use strict';

    // Wait for JAI adapter to be ready (it's sync in Pure)
    const JAI = A.Adapters['jai'];
    if (!JAI) {
        console.warn('[Env] JAI Adapter not found during renderer load.');
        return;
    }

    // Add Render Capability
    JAI.render = function (ir) {
        // Basic JAI Script Wrapper
        // Based on ScriptBuilder 3000 Standard Template

        const timestamp = new Date().toISOString();

        let buffer = `// ${ir.meta.name}\n`;
        buffer += `// Generated by Anansi on ${timestamp}\n`;
        buffer += `// Environment: JanitorAI (Unified)\n\n`;

        buffer += `(function() {\n`;
        buffer += `  'use strict';\n\n`;

        buffer += `  // --- Anansi Data Bundle ---\n`;
        // Serialize weaves (Lorebook, etc)
        const bundle = {
            meta: ir.meta,
            weaves: ir.weaves,
            env: ir.env
        };
        buffer += `  const BUNDLE = ${JSON.stringify(bundle, null, 2)};\n\n`;

        buffer += `  // --- Runtime Engine ---\n`;
        // Inject LogicEngine Class
        if (window.LogicEngine) {
            buffer += `  ${window.LogicEngine.constructor.toString()}\n`;
            buffer += `  const Engine = new LogicEngine();\n`;
            buffer += `  console.log('[Anansi] Logic Engine initialized.');\n\n`;
        } else {
            buffer += `  console.warn('[Anansi] LogicEngine source not found during build.');\n\n`;
        }

        buffer += `  // --- User Scripts ---\n`;

        ir.scripts.forEach((script, i) => {
            buffer += `  // Script ${i + 1}: ${script.name}\n`;
            buffer += `  try {\n`;
            // Indent user code for readability
            const indented = script.code.split('\n').map(line => '    ' + line).join('\n');
            buffer += indented + `\n`;
            buffer += `  } catch (e) {\n`;
            buffer += `    console.error('Anansi Script Error (${script.name}):', e);\n`;
            buffer += `  }\n\n`;
        });

        buffer += `})();\n`;

        return buffer;
    };

    JAI.meta.extension = 'js';

    console.log('[Env] JAI Renderer attached.');

})(window.Anansi);
